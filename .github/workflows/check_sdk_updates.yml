name: Check SDK Updates

on:
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  check-release:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º 30 åˆ†é’Ÿ
    strategy:
      matrix:
        repo:
          - "facebook/facebook-ios-sdk"            # Facebook SDK
          - "adjust/ios_sdk"                       # Adjust SDK
          - "firebase/firebase-ios-sdk"            # Firebase SDK
          - "adjust/adjust_signature_sdk"          # Adjust Signature SDK

    steps:
      # âœ… 1. æ‹‰å–ä»£ç ä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # âœ… 2. è®¾ç½® Python ç¯å¢ƒ
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      # âœ… 3. å®‰è£…å¿…è¦çš„åº“
      - name: Install dependencies
        run: |
          pip install requests

      # âœ… 4. è·å–æœ€æ–°ç‰ˆæœ¬
      - name: Check for new release
        id: check-release
        run: |
          python -c "
import requests
import os

REPO = '${{ matrix.repo }}'
API_URL = f'https://api.github.com/repos/{REPO}/releases/latest'

response = requests.get(API_URL)
if response.status_code != 200:
    print(f'âŒ æ— æ³•è·å– {REPO} çš„æœ€æ–°ç‰ˆæœ¬')
    exit(1)

latest_version = response.json()['tag_name']
release_url = response.json()['html_url']

# æ–‡ä»¶å‘½åä¸ºä»“åº“åï¼Œé˜²æ­¢å†²çª
version_file = REPO.replace('/', '_') + '_latest_version.txt'

# è¯»å–å·²ä¿å­˜çš„ç‰ˆæœ¬å·
try:
    with open(version_file, 'r') as f:
        saved_version = f.read().strip()
except FileNotFoundError:
    saved_version = None

if latest_version != saved_version:
    with open(version_file, 'w') as f:
        f.write(latest_version)
    print(f'ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ: {latest_version} - {release_url}')

    # è®¾ç½®è¾“å‡ºï¼Œä¾›ä¸‹ä¸€ä¸ªæ­¥éª¤ä½¿ç”¨
    with open(os.environ['GITHUB_ENV'], 'a') as env_file:
        env_file.write(f'NEW_VERSION={latest_version}\n')
        env_file.write(f'RELEASE_URL={release_url}\n')
        env_file.write(f'SDK={REPO}\n')
else:
    print(f'âœ… {REPO} å·²æ˜¯æœ€æ–°ç‰ˆæœ¬')
"
      
      # âœ… 5. å‘é€ GitHub Actions é€šçŸ¥
      - name: Send GitHub Notification
        if: env.NEW_VERSION != ''
        run: |
          echo "ğŸš€ æ–°ç‰ˆæœ¬: ${{ env.NEW_VERSION }}"
          echo "ğŸ”— é“¾æ¥: ${{ env.RELEASE_URL }}"
          echo "ğŸ“¦ SDK: ${{ env.SDK }}"

      # âœ… 6. å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
      - name: Send Email Notification
        if: env.NEW_VERSION != ''
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          TO_EMAIL: ${{ secrets.TO_EMAIL }}
        run: |
          if [ -n "$SMTP_SERVER" ]; then
            echo "Sending email notification..."
            SUBJECT="SDK æ›´æ–°: $SDK $NEW_VERSION"
            BODY="æ–°ç‰ˆæœ¬å‘å¸ƒ: $SDK\n\nç‰ˆæœ¬å·: $NEW_VERSION\nä¸‹è½½é“¾æ¥: $RELEASE_URL"
            echo -e "Subject:$SUBJECT\n\n$BODY" | sendmail -v $TO_EMAIL
          else
            echo "âŒ SMTP æœªé…ç½®ï¼Œè·³è¿‡é‚®ä»¶å‘é€"
          fi

      # âœ… å‘é€ Telegram é€šçŸ¥
      - name: Send Telegram Notification
        if: env.NEW_VERSION != ''
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            MESSAGE="ğŸš€ æ–°ç‰ˆæœ¬å‘å¸ƒ\nğŸ“¦ SDK: $SDK\nğŸ”– ç‰ˆæœ¬å·: $NEW_VERSION\nğŸ”— é“¾æ¥: $RELEASE_URL"
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="$MESSAGE"
            echo "âœ… Telegram é€šçŸ¥å·²å‘é€"
          else
            echo "âŒ Telegram Token æˆ– Chat ID æœªé…ç½®"
