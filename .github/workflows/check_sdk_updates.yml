name: Check SDK Updates

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

concurrency:
  group: check-sdk-updates-${{ matrix.repo }}
  cancel-in-progress: true

jobs:
  check-release:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        repo:
          - "facebook/facebook-ios-sdk"
          - "adjust/ios_sdk"
          - "firebase/firebase-ios-sdk"
          - "adjust/adjust_signature_sdk"

    steps:
      # âœ… 1. æ‹‰å–ä»£ç ä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4

      # âœ… 2. ç¼“å­˜ç‰ˆæœ¬æ–‡ä»¶
      - name: Cache SDK version files
        id: cache-versions
        uses: actions/cache@v3
        with:
          path: versions
          key: sdk-versions-v3-${{ matrix.repo }}-${{ github.run_id }}
          restore-keys: |
            sdk-versions-v3-${{ matrix.repo }}-
            sdk-versions-v3-${{ matrix.repo }}
            sdk-versions-v2-${{ matrix.repo }}-
            sdk-versions-v1-${{ matrix.repo }}-
            sdk-versions-${{ matrix.repo }}-
            sdk-versions-

      # âœ… 3. è°ƒè¯•ç¼“å­˜æ¢å¤
      - name: Debug cache restore
        run: |
          echo "ğŸ“‚ ç¼“å­˜æ¢å¤åçš„ç‰ˆæœ¬æ–‡ä»¶ç›®å½•å†…å®¹ï¼š"
          ls -la versions/ || echo "âš ï¸ ç‰ˆæœ¬ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
          VERSION_FILE="versions/$(echo ${{ matrix.repo }} | tr '/' '_')_latest_version.txt"
          if [ -f "$VERSION_FILE" ]; then
            echo "âœ… ç¼“å­˜ä¸­çš„ç‰ˆæœ¬æ–‡ä»¶å­˜åœ¨ï¼Œå†…å®¹ï¼š"
            cat "$VERSION_FILE"
          else
            echo "âŒ ç¼“å­˜ä¸­çš„ç‰ˆæœ¬æ–‡ä»¶æœªæ‰¾åˆ°"
          fi

      # âœ… 4. éªŒè¯ç¼“å­˜å‘½ä¸­
      - name: Verify cache hit
        run: |
          if [ "${{ steps.cache-versions.outputs.cache-hit }}" == "true" ]; then
            echo "âœ… ç¼“å­˜å‘½ä¸­ï¼Œç‰ˆæœ¬æ–‡ä»¶å·²æ¢å¤"
            ls -la versions/
          else
            echo "âš ï¸ ç¼“å­˜æœªå‘½ä¸­ï¼Œå°†åˆ›å»ºæ–°çš„ç‰ˆæœ¬æ–‡ä»¶"
          fi

      # âœ… 5. è®¾ç½® Python ç¯å¢ƒ
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # âœ… 6. å®‰è£…å¿…è¦çš„åº“
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade requests packaging setuptools

      # âœ… 7. è°ƒè¯• Python ç¯å¢ƒ
      - name: Verify installed dependencies
        run: |
          python --version
          pip --version
          pip list | grep packaging || echo "âŒ packaging æœªå®‰è£…"

      # âœ… 8. éªŒè¯ check_release.py æ˜¯å¦å­˜åœ¨
      - name: Verify check_release.py exists
        run: |
          ls -la
          if [ -f "check_release.py" ]; then
            echo "âœ… check_release.py found in root directory"
          else
            echo "âŒ check_release.py not found in root directory"
            exit 1
          fi

      # âœ… 9. è·å–æœ€æ–°ç‰ˆæœ¬
      - name: Check for new release
        id: check-release
        env:
          REPO: ${{ matrix.repo }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_PAT }}
        run: |
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ç¯å¢ƒå˜é‡ REPO: $REPO"
          echo "ç¯å¢ƒå˜é‡ GITHUB_TOKEN: ${GITHUB_TOKEN:0:5}..."
          python check_release.py

      # âœ… 10. éªŒè¯ç‰ˆæœ¬æ–‡ä»¶å†…å®¹
      - name: Verify version file after script
        run: |
          echo "ğŸ“‚ ç‰ˆæœ¬æ–‡ä»¶ç›®å½•å†…å®¹ï¼š"
          ls -la versions/
          VERSION_FILE="versions/$(echo ${{ matrix.repo }} | tr '/' '_')_latest_version.txt"
          if [ -f "$VERSION_FILE" ]; then
            echo "âœ… ç‰ˆæœ¬æ–‡ä»¶å­˜åœ¨ï¼Œå†…å®¹ï¼š"
            cat "$VERSION_FILE"
          else
            echo "âŒ ç‰ˆæœ¬æ–‡ä»¶æœªæ‰¾åˆ°"
          fi

      # âœ… 11. ä¿å­˜ç‰ˆæœ¬æ–‡ä»¶åˆ°ç¼“å­˜ï¼ˆå§‹ç»ˆä¿å­˜ï¼‰
      - name: Save version files to cache
        uses: actions/cache@v3
        with:
          path: versions
          key: sdk-versions-v3-${{ matrix.repo }}-${{ github.run_id }}

      # âœ… 12. å‘é€ GitHub Actions é€šçŸ¥
      - name: Send GitHub Notification
        if: env.NEW_VERSION != ''
        run: |
          echo "::notice title=SDK æ›´æ–°é€šçŸ¥::ğŸš€ æ–°ç‰ˆæœ¬: ${{ env.NEW_VERSION }} ğŸ”— [æŸ¥çœ‹](${{ env.RELEASE_URL }}) ğŸ“¦ SDK: ${{ env.SDK }}"

      # âœ… 13. å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
      - name: Send Email Notification
        if: env.NEW_VERSION != ''
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          TO_EMAIL: ${{ secrets.TO_EMAIL }}
        run: |
          if [ -n "$SMTP_SERVER" ]; then
            echo "Sending email notification..."
            SUBJECT="SDK æ›´æ–°: $SDK $NEW_VERSION"
            BODY="æ–°ç‰ˆæœ¬å‘å¸ƒ: $SDK\n\nç‰ˆæœ¬å·: $NEW_VERSION\nä¸‹è½½é“¾æ¥: $RELEASE_URL"
            echo -e "Subject:$SUBJECT\n\n$BODY" | sendmail -v $TO_EMAIL || echo "âŒ é‚®ä»¶å‘é€å¤±è´¥"
          else
            echo "âŒ SMTP æœªé…ç½®ï¼Œè·³è¿‡é‚®ä»¶å‘é€"
          fi

      # âœ… 14. å‘é€ Telegram é€šçŸ¥
      - name: Send Telegram Notification
        if: env.NEW_VERSION != ''
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            MESSAGE="""ğŸš€ *æ–°ç‰ˆæœ¬å‘å¸ƒ*
            ğŸ“¦ SDK: \`${SDK}\`
            ğŸ”– ç‰ˆæœ¬å·: \`${NEW_VERSION}\`
            ğŸ”— [ç‚¹å‡»æŸ¥çœ‹](${RELEASE_URL})"""
            
            JSON=$(jq -n --arg chat_id "$TELEGRAM_CHAT_ID" --arg text "$MESSAGE" '{chat_id: $chat_id, text: $text, parse_mode: "Markdown"}')

            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -H "Content-Type: application/json" \
              -d "$JSON"

            echo "âœ… Telegram é€šçŸ¥å·²å‘é€"
          else
            echo "âŒ Telegram Token æˆ– Chat ID æœªé…ç½®"
          fi
