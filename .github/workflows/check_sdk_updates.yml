name: Check SDK Updates

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

concurrency:
  group: check-sdk-updates-${{ github.run_id }}
  cancel-in-progress: true

jobs:
  check-release:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        repo:
          - "facebook/facebook-ios-sdk"
          - "adjust/ios_sdk"
          - "firebase/firebase-ios-sdk"
          - "adjust/adjust_signature_sdk"

    # Serialize commits within the same run, but allow different runs to coexist
    concurrency:
      group: check-sdk-updates-commit-${{ github.run_id }}
      cancel-in-progress: false

    steps:
      # ✅ 1. 调试 PAT_TOKEN
      - name: Debug PAT_TOKEN
        run: |
          if [ -n "${{ secrets.PAT_TOKEN }}" ]; then
            echo "✅ PAT_TOKEN is set (first 5 chars): ${PAT_TOKEN:0:5}..."
          else
            echo "❌ PAT_TOKEN is not set"
            exit 1
          fi
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

      # ✅ 2. 拉取代码仓库
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      # ✅ 3. 设置 Python 环境
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # ✅ 4. 安装必要的库
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade requests packaging setuptools

      # ✅ 5. 调试 Python 环境
      - name: Verify installed dependencies
        run: |
          python --version
          pip --version
          pip list | grep packaging || echo "❌ packaging 未安装"

      # ✅ 6. 验证 check_release.py 是否存在
      - name: Verify check_release.py exists
        run: |
          ls -la
          if [ -f "check_release.py" ]; then
            echo "✅ check_release.py found in root directory"
          else
            echo "❌ check_release.py not found in root directory"
            exit 1
          fi

      # ✅ 7. 验证 versions.json 是否存在
      - name: Verify versions.json exists
        run: |
          if [ -f "versions.json" ]; then
            echo "✅ versions.json found in root directory"
            cat versions.json
          else
            echo "❌ versions.json not found in root directory"
            exit 1
          fi

      # ✅ 8. 获取最新版本
      - name: Check for new release
        id: check-release
        env:
          REPO: ${{ matrix.repo }}
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "当前工作目录: $(pwd)"
          echo "环境变量 REPO: $REPO"
          echo "环境变量 GITHUB_TOKEN: ${GITHUB_TOKEN:0:5}..."
          python check_release.py

      # ✅ 9. 提交更新的 versions.json
      - name: Commit updated versions.json
        if: env.VERSION_UPDATED == 'true'
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          # Debug the working directory state
          echo "🔍 Debugging working directory state before commit..."
          git status
          cat versions.json
          
          # Stage changes
          git add versions.json
          
          # Retry the pull-rebase and push operation
          for i in {1..3}; do
            git pull --rebase origin main
            if [ $? -eq 0 ]; then
              # If pull succeeds, commit and push
              git commit -m "Update versions.json with new SDK version: ${{ env.SDK }}@${{ env.NEW_VERSION }}" || echo "No changes to commit (already committed by another job)"
              git push && break
            else
              echo "❌ Pull failed, attempting to resolve conflicts..."
              git rebase --abort || true  # Abort the rebase if it fails
              # Fetch the remote version of versions.json
              git fetch origin
              git checkout origin/main -- versions.json
              # Re-apply local changes (rerun the script to regenerate versions.json)
              python check_release.py
              git add versions.json
              git commit -m "Update versions.json with new SDK version: ${{ env.SDK }}@${{ env.NEW_VERSION }} after conflict resolution"
              git push && break
            fi
            echo "Pull or push failed, retrying ($i/3)..."
            sleep $((i * 5))
          done
          if [ $i -eq 3 ]; then
            echo "❌ Failed to push after 3 retries"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

      # ✅ 10. 发送 GitHub Actions 通知
      - name: Send GitHub Notification
        if: env.VERSION_UPDATED == 'true'
        run: |
          echo "::notice title=SDK 更新通知::🚀 新版本: ${{ env.NEW_VERSION }} 🔗 [查看](${{ env.RELEASE_URL }}) 📦 SDK: ${{ env.SDK }}"

      # ✅ 11. 发送邮件通知（如果需要）
      - name: Send Email Notification
        if: env.VERSION_UPDATED == 'true'
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          TO_EMAIL: ${{ secrets.TO_EMAIL }}
        run: |
          if [ -n "$SMTP_SERVER" ]; then
            echo "Sending email notification..."
            SUBJECT="SDK 更新: $SDK $NEW_VERSION"
            BODY="新版本发布: $SDK\n\n版本号: $NEW_VERSION\n下载链接: $RELEASE_URL"
            echo -e "Subject:$SUBJECT\n\n$BODY" | sendmail -v $TO_EMAIL || echo "❌ 邮件发送失败"
          else
            echo "❌ SMTP 未配置，跳过邮件发送"
          fi

      # ✅ 12. 发送 Telegram 通知
      - name: Send Telegram Notification
        if: env.VERSION_UPDATED == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            MESSAGE="""🚀 *新版本发布*
            📦 SDK: \`${SDK}\`
            🔖 版本号: \`${NEW_VERSION}\`
            🔗 [点击查看](${RELEASE_URL})"""
            
            JSON=$(jq -n --arg chat_id "$TELEGRAM_CHAT_ID" --arg text "$MESSAGE" '{chat_id: $chat_id, text: $text, parse_mode: "Markdown"}')

            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -H "Content-Type: application/json" \
              -d "$JSON"

            echo "✅ Telegram 通知已发送"
          else
            echo "❌ Telegram Token 或 Chat ID 未配置"
          fi
