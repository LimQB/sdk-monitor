name: Check SDK Updates

on:
  schedule:
    - cron: '0 * * * *' # æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  check-release:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º 30 åˆ†é’Ÿ
    strategy:
      fail-fast: false
      matrix:
        repo:
          - "facebook/facebook-ios-sdk"            # Facebook SDK
          - "adjust/ios_sdk"                       # Adjust SDK
          - "firebase/firebase-ios-sdk"            # Firebase SDK
          - "adjust/adjust_signature_sdk"          # Adjust Signature SDK

    steps:
      # âœ… 1. æ‹‰å–ä»£ç ä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # âœ… 2. è®¾ç½® Python ç¯å¢ƒ
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      # âœ… 3. å®‰è£…å¿…è¦çš„åº“
      - name: Install dependencies
        run: |
          pip install requests
      
      # âœ… 4. è°ƒè¯• Python ç¯å¢ƒ
      - name: Verify Python and requests
        run: |
          python --version
          pip show requests

      # âœ… 5. éªŒè¯ check_release.py æ˜¯å¦å­˜åœ¨
      - name: Verify check_release.py exists
        run: |
          ls -la
          if [ -f "check_release.py" ]; then
            echo "âœ… check_release.py found in root directory"
          else
            echo "âŒ check_release.py not found in root directory"
            exit 1
          fi

      # âœ… 6. è·å–æœ€æ–°ç‰ˆæœ¬
      - name: Check for new release
        id: check-release
        env:
          REPO: ${{ matrix.repo }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_PAT }}
        run: |
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ç¯å¢ƒå˜é‡ REPO: $REPO"
          echo "ç¯å¢ƒå˜é‡ GITHUB_TOKEN: ${GITHUB_TOKEN:0:5}..."
          python check_release.py
        continue-on-error: true

      # âœ… 7. å‘é€ GitHub Actions é€šçŸ¥
      - name: Send GitHub Notification
        if: env.NEW_VERSION != ''
        run: |
          echo "ğŸš€ æ–°ç‰ˆæœ¬: ${{ env.NEW_VERSION }}"
          echo "ğŸ”— é“¾æ¥: ${{ env.RELEASE_URL }}"
          echo "ğŸ“¦ SDK: ${{ env.SDK }}"

      # âœ… 8. å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
      - name: Send Email Notification
        if: env.NEW_VERSION != ''
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          TO_EMAIL: ${{ secrets.TO_EMAIL }}
        run: |
          python -c "
          import smtplib
          from email.mime.text import MIMEText

          smtp_server = '$SMTP_SERVER'
          smtp_port = int('$SMTP_PORT' or 587)
          smtp_user = '$SMTP_USER'
          smtp_password = '$SMTP_PASSWORD'
          to_email = '$TO_EMAIL'

          if not all([smtp_server, smtp_port, smtp_user, smtp_password, to_email]):
              print('âŒ SMTP é…ç½®ä¸å®Œæ•´ï¼Œè·³è¿‡é‚®ä»¶å‘é€')
              exit(0)

          subject = 'SDK æ›´æ–°: $SDK $NEW_VERSION'
          body = 'æ–°ç‰ˆæœ¬å‘å¸ƒ: $SDK\n\nç‰ˆæœ¬å·: $NEW_VERSION\nä¸‹è½½é“¾æ¥: $RELEASE_URL'
          msg = MIMEText(body)
          msg['Subject'] = subject
          msg['From'] = smtp_user
          msg['To'] = to_email

          try:
              with smtplib.SMTP(smtp_server, smtp_port) as server:
                  server.starttls()
                  server.login(smtp_user, smtp_password)
                  server.sendmail(smtp_user, to_email, msg.as_string())
                  print('âœ… é‚®ä»¶é€šçŸ¥å·²å‘é€')
          except Exception as e:
              print(f'âŒ é‚®ä»¶å‘é€å¤±è´¥: {str(e)}')
              exit(1)
          "

      # âœ… 9. å‘é€ Telegram é€šçŸ¥
      - name: Send Telegram Notification
        if: env.NEW_VERSION != ''
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            MESSAGE="ğŸš€ æ–°ç‰ˆæœ¬å‘å¸ƒ\nğŸ“¦ SDK: $SDK\nğŸ”– ç‰ˆæœ¬å·: $NEW_VERSION\nğŸ”— é“¾æ¥: $RELEASE_URL"
            RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="$MESSAGE")
            if echo "$RESPONSE" | grep -q '"ok":true'; then
              echo "âœ… Telegram é€šçŸ¥å·²å‘é€"
            else
              echo "âŒ Telegram é€šçŸ¥å‘é€å¤±è´¥: $RESPONSE"
              exit 1
            fi
          else
            echo "âŒ Telegram Token æˆ– Chat ID æœªé…ç½®"
          fi
