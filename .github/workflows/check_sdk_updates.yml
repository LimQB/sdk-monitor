name: Check SDK Updates

on:
  schedule:
    - cron: '0 * * * *' # æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

concurrency:
  group: check-sdk-updates
  cancel-in-progress: false

jobs:
  check-release:
    runs-on: ubuntu-latest
    timeout-minutes: 30 # è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º 30 åˆ†é’Ÿ
    strategy:
      fail-fast: false
      matrix:
        repo:
          - "facebook/facebook-ios-sdk"        # Facebook SDK
          - "adjust/ios_sdk"                   # Adjust SDK
          - "firebase/firebase-ios-sdk"        # Firebase SDK
          - "adjust/adjust_signature_sdk"      # Adjust Signature SDK
      max-parallel: 1

    steps:
      # âœ… 1. éªŒè¯ PAT_TOKEN æ˜¯å¦å­˜åœ¨
      - name: Debug PAT_TOKEN
        run: |
          if [ -n "${{ secrets.PAT_TOKEN }}" ]; then
            echo "âœ… PAT_TOKEN is set (first 5 chars): ${PAT_TOKEN:0:5}..."
          else
            echo "âŒ PAT_TOKEN is not set"
            exit 1
          fi
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

      # âœ… 2. æ‹‰å–ä»£ç ä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      # âœ… 3. è®¾ç½® Python ç¯å¢ƒ
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # âœ… 4. å®‰è£…å¿…è¦çš„åº“
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade requests packaging setuptools

      # âœ… 5. è°ƒè¯• Python ç¯å¢ƒ
      - name: Verify installed dependencies
        run: |
          python --version
          pip --version
          pip list | grep packaging || echo "âŒ packaging æœªå®‰è£…"

      # âœ… 6. éªŒè¯ check_release.py æ˜¯å¦å­˜åœ¨
      - name: Verify check_release.py exists
        run: |
          ls -la
          if [ -f "check_release.py" ]; then
            echo "âœ… check_release.py found in root directory"
          else
            echo "âŒ check_release.py not found in root directory"
            exit 1
          fi

      # âœ… 7. éªŒè¯ versions.json æ˜¯å¦å­˜åœ¨
      - name: Verify versions.json exists
        run: |
          if [ -f "versions.json" ]; then
            echo "âœ… versions.json found in root directory"
            cat versions.json
          else
            echo "âŒ versions.json not found in root directory"
            exit 1
          fi

      # âœ… 8. éªŒè¯ REPO å˜é‡æ˜¯å¦å­˜åœ¨
      - name: Debug REPO variable
        run: |
          echo "REPO variable: ${{ matrix.repo }}"
          if [ -z "${{ matrix.repo }}" ]; then
            echo "âŒ REPO variable is not set"
            exit 1
          fi

      # âœ… 9. å»¶è¿Ÿä»¥é¿å…é€Ÿç‡é™åˆ¶
      - name: Delay to avoid rate limits
        run: sleep $((RANDOM % 10))

      # âœ… 10. è·å–SDKæœ€æ–°ç‰ˆæœ¬
      - name: Check for new release
        id: check-release
        env:
          REPO: ${{ matrix.repo }}
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ç¯å¢ƒå˜é‡ REPO: $REPO"
          echo "ç¯å¢ƒå˜é‡ GITHUB_TOKEN: ${GITHUB_TOKEN:0:5}..."
          python check_release.py

      # âœ… 11. æäº¤å·²æ›´æ–°çš„ versions.json
      - name: Commit updated versions.json
        if: env.VERSION_UPDATED == 'true'
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          echo "ğŸ” Debugging working directory state before commit..."
          git status
          cat versions.json
          
          git add versions.json
          git commit -m "Update versions.json with new SDK version: ${{ env.SDK }}@${{ env.NEW_VERSION }}" || { echo "âŒ git commit failed"; exit 128; }
          
          success=false
          for i in {1..3}; do
            echo "ğŸ” Pushing attempt $i/3"
            if git push origin main; then
              success=true
              break
            fi
            echo "Push failed, retrying ($i/3)..."
            git fetch origin
            git pull --rebase || {
              echo "âš ï¸ Rebase failed, resetting to origin/main..."
              git rebase --abort || true
              git reset --hard origin/main
              python check_release.py
              git add versions.json
              git commit -m "Update versions.json with new SDK version: ${{ env.SDK }}@${{ env.NEW_VERSION }} after conflict" || { echo "âŒ git commit failed after rebase"; exit 128; }
            }
            sleep $((i * 5))
          done
          if [ "$success" != "true" ]; then
            echo "âŒ Failed to push after 3 retries"
            exit 1
          fi
        env:
          REPO: ${{ matrix.repo }}
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

      # âœ… 12. å¤±è´¥æ—¶æ¢å¤versions.json
      - name: Revert versions.json on failure
        if: failure()
        run: |
          if [ -f "versions.json" ]; then
            git checkout -- versions.json || echo "âš ï¸ æ— æ³•è¿˜åŸ versions.json"
            echo "âœ… Reverted versions.json due to job failure"
          else
            echo "âš ï¸ versions.json ä¸å­˜åœ¨ï¼Œæ— éœ€è¿˜åŸ"
          fi
        env:
          REPO: ${{ matrix.repo }}
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

      # âœ… 13. å‘é€ GitHub Actions é€šçŸ¥
      - name: Send GitHub Notification
        if: env.VERSION_UPDATED == 'true'
        run: |
          echo "::warning title=SDK æ›´æ–°é€šçŸ¥::ğŸš€ æ–°ç‰ˆæœ¬: ${{ env.NEW_VERSION }} ğŸ”— [æŸ¥çœ‹](${{ env.RELEASE_URL }}) ğŸ“¦ SDK: ${{ env.SDK }}"

      # âœ… 14. å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
      - name: Send Email Notification
        if: env.VERSION_UPDATED == 'true'
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          TO_EMAIL: ${{ secrets.TO_EMAIL }}
        run: |
          if [ -n "$SMTP_SERVER" ] && [ -n "$SMTP_PORT" ] && [ -n "$SMTP_USER" ] && [ -n "$SMTP_PASSWORD" ] && [ -n "$TO_EMAIL" ]; then
            echo "ğŸ“§ Sending email notification..."
            SUBJECT="SDK æ›´æ–°: $SDK $NEW_VERSION"
            BODY="æ–°ç‰ˆæœ¬å‘å¸ƒ: $SDK\n\nç‰ˆæœ¬å·: $NEW_VERSION\nä¸‹è½½é“¾æ¥: $RELEASE_URL"
            echo -e "Subject:$SUBJECT\n\n$BODY" | sendmail -v -f "$SMTP_USER" -s "$SMTP_SERVER:$SMTP_PORT" -xu "$SMTP_USER" -xp "$SMTP_PASSWORD" "$TO_EMAIL" && {
              echo "âœ… Email é€šçŸ¥å·²å‘é€"
            } || {
              echo "âŒ Email é€šçŸ¥å‘é€å¤±è´¥"
            }
          else
            echo "âŒ SMTP é…ç½®ä¸å®Œæ•´ï¼Œè·³è¿‡é‚®ä»¶å‘é€"
            echo "SMTP_SERVER: $SMTP_SERVER"
            echo "SMTP_PORT: $SMTP_PORT"
            echo "SMTP_USER: $SMTP_USER"
            echo "TO_EMAIL: $TO_EMAIL"
          fi

      # âœ… 15. å‘é€ Telegram é€šçŸ¥  
      - name: Send Telegram Notification
        if: env.VERSION_UPDATED == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            echo "ğŸ“¬ Sending Telegram notification..."
            MESSAGE="ğŸš€ *æ–°ç‰ˆæœ¬å‘å¸ƒ*
          ğŸ“¦ SDK: \`${SDK}\`
          ğŸ”– ç‰ˆæœ¬å·: \`${NEW_VERSION}\`
          ğŸ”— [ç‚¹å‡»æŸ¥çœ‹](${RELEASE_URL})"
            JSON=$(jq -n --arg chat_id "$TELEGRAM_CHAT_ID" --arg text "$MESSAGE" '{chat_id: $chat_id, text: $text, parse_mode: "Markdown"}')
            RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -H "Content-Type: application/json" \
              -d "$JSON")
            if echo "$RESPONSE" | jq -e '.ok' > /dev/null; then
              echo "âœ… Telegram é€šçŸ¥å·²å‘é€"
            else
              echo "âŒ Telegram é€šçŸ¥å‘é€å¤±è´¥: $(echo "$RESPONSE" | jq -r '.description')"
            fi
          else
            echo "âŒ Telegram Token æˆ– Chat ID æœªé…ç½®"
            echo "TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:0:5}..."
            echo "TELEGRAM_CHAT_ID: $TELEGRAM_CHAT_ID"
          fi
